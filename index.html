<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Renegociação | Quitação antecipada (VP)</title>
  <style>
    :root{
      --bg:#f3f9ff;
      --card:#ffffff;
      --ink:#0f2233;
      --muted:#5a7286;
      --brand:#1f7daa;
      --brand2:#2c95d6;
      --line:#d7e6f2;
      --soft:#edf4fb;
      --danger:#b00020;
      --dangerSoft:#fdecee;
      --ok:#0a7a3c;
      --okSoft:#e7f6ee;
      --shadow: 0 10px 30px rgba(15,34,51,.08);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:var(--bg);
    }
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px;}
    .hero{
      background:linear-gradient(90deg,var(--brand),var(--brand2));
      color:#fff;
      border-radius:16px;
      padding:18px 22px;
      box-shadow: var(--shadow);
      font-weight:800;
      font-size:28px;
      letter-spacing:.2px;
    }
    .grid{display:grid;grid-template-columns: 1.1fr .9fr; gap:16px; margin-top:16px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px;
      background: #f7fbff;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      font-weight:800;
    }
    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background: var(--okSoft);
      color: var(--ok);
      border:1px solid rgba(10,122,60,.2);
      font-weight:700;
      display:none;
      white-space:nowrap;
    }
    .content{padding:16px;}
    .twoCol{display:grid;grid-template-columns: 1fr 1fr; gap:12px;}
    @media (max-width: 620px){ .twoCol{grid-template-columns:1fr} }
    label{display:block;font-size:12px;color:var(--muted);margin:2px 0 6px;}
    input, select, textarea{
      width:100%;
      padding:11px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
      font-size:14px;
      color:var(--ink);
      outline:none;
    }
    input:focus, select:focus, textarea:focus{border-color:#9fd0ee; box-shadow:0 0 0 3px rgba(44,149,214,.15)}
    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px;}
    .btn{
      border:0;
      border-radius:999px;
      padding:11px 16px;
      font-weight:800;
      cursor:pointer;
      transition: transform .05s ease, filter .2s ease;
      user-select:none;
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{background:var(--brand); color:#fff;}
    .btn.ghost{background:#fff; color:var(--brand); border:1px solid rgba(31,125,170,.35);}
    .btn.red{background:var(--danger); color:#fff;}
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .kpi{
      border:1px solid rgba(176,0,32,.25);
      background:var(--dangerSoft);
      border-radius:16px;
      padding:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .kpi .big{
      font-size:28px;
      font-weight:900;
      letter-spacing:.2px;
      color:var(--danger);
      margin:0;
    }
    .kpi .sub{font-size:12px;color:#7b2a36;font-weight:700}
    .miniCards{display:grid;grid-template-columns: 1fr 1fr 1fr; gap:10px;}
    @media (max-width: 620px){ .miniCards{grid-template-columns:1fr} }
    .mini{
      background:#fff;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
    }
    .mini .t{font-size:12px;color:var(--muted);font-weight:700;margin-bottom:4px}
    .mini .v{font-size:14px;font-weight:900}
    .note{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35}
    .sectionTitle{
      font-weight:900;
      margin: 18px 0 10px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--soft);
      font-size:13px;
      text-align:right;
      white-space:nowrap;
    }
    th{background:#f7fbff;color:#183549;font-weight:900}
    td:first-child, th:first-child{text-align:center}
    td:nth-child(2), th:nth-child(2){text-align:left}
    tr:last-child td{border-bottom:0}
    tr.eventRow td{
      background: var(--dangerSoft);
      color: var(--danger);
      font-weight:900;
      text-align:left !important;
    }
    tr.eventRow td span.small{color:#7b2a36;font-weight:800;font-size:12px}
    .collapse{
      border-top:1px solid var(--line);
      background:#fbfdff;
    }
    .collapse summary{
      cursor:pointer;
      padding:12px 16px;
      font-weight:900;
      color:#183549;
      list-style:none;
    }
    .collapse summary::-webkit-details-marker{display:none}
    .collapse .inner{padding:0 16px 16px;color:var(--muted);font-size:12px;line-height:1.35}
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px;
      background:#0f2233; color:#fff;
      padding:10px 14px; border-radius:999px;
      font-weight:800; font-size:13px;
      box-shadow: 0 12px 30px rgba(0,0,0,.2);
      opacity:0; pointer-events:none;
      transition:opacity .25s ease, transform .25s ease;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-3px);}
    .spinner{
      width:14px;height:14px;border-radius:999px;border:2px solid rgba(255,255,255,.4);
      border-top-color:#fff; display:inline-block; vertical-align:-2px; margin-right:8px;
      animation: spin .8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg);} }

    /* Minimal SVG diagram wrapper */
    .diagramWrap{
      border:1px solid var(--line);
      background:#fff;
      border-radius:16px;
      padding:12px;
    }
    .diagramTitle{font-weight:900;color:#183549;margin:0 0 8px}
    .diagramHint{font-size:12px;color:var(--muted);margin:8px 0 0}
    .mutedRow{color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">Renegociação</div>

    <div class="grid">
      <!-- Inputs -->
      <div class="card">
        <div class="hd">
          <div>1) Dados do contrato e parâmetros</div>
          <div class="badge" id="badgeOk">simulação processada</div>
        </div>
        <div class="content">
          <div class="twoCol">
            <div>
              <label>Nº(s) do(s) contrato(s)</label>
              <input id="contratos" value="39145" />
            </div>
            <div>
              <label>Colaborador responsável</label>
              <input id="colaborador" value="Lauriana" />
            </div>
            <div>
              <label>Nome do solicitante</label>
              <input id="solicitante" value="Eduardo Araujo" />
            </div>
            <div>
              <label>E-mail de contato</label>
              <input id="email" value="economista.araujo@gmail.com" />
            </div>
            <div>
              <label>Valor negociado (R$)</label>
              <input id="negociado" value="35000,00" inputmode="decimal" />
            </div>
            <div>
              <label>Sinal (R$)</label>
              <input id="sinal" value="7000,00" inputmode="decimal" />
            </div>
            <div>
              <label>Taxa de juros (% a.a.)</label>
              <input id="jurosAA" value="8" inputmode="decimal" />
            </div>
            <div>
              <label>Periodicidade</label>
              <select id="periodicidade">
                <option value="ANUAL" selected>Anual</option>
                <option value="MENSAL">Mensal</option>
              </select>
            </div>
            <div>
              <label>Número de prestações (n)</label>
              <input id="n" value="5" inputmode="numeric" />
            </div>
            <div>
              <label>1º vencimento (dd/mm/aaaa)</label>
              <input id="primeiroVenc" value="02/03/2027" inputmode="numeric" maxlength="10" />
            </div>
            <div>
              <label>Data-base (assinatura) (dd/mm/aaaa)</label>
              <input id="dataBase" value="25/12/2025" inputmode="numeric" maxlength="10" />
            </div>
            <div>
              <label>Convenção de dias</label>
              <select id="dayCount">
                <option value="ACT365" selected>ACT/365 (dias corridos)</option>
              </select>
            </div>
          </div>

          <div class="actions">
            <button class="btn primary" id="btnCalc"><span id="btnCalcIcon"></span>Calcular quitação</button>
            <button class="btn ghost" id="btnTabela">Ver tabela (fluxo)</button>
            <button class="btn red" id="btnPDF">Gerar PDF</button>
          </div>
          <div class="note">Ação principal: calcular o valor para quitação por VP das parcelas vincendas. A tabela é apenas conferência do fluxo.</div>
        </div>
      </div>

      <!-- Quitação -->
      <div class="card">
        <div class="hd">
          <div>2) Cálculo de quitação antecipada</div>
          <div class="badge" id="badgeVP">VP</div>
        </div>
        <div class="content">
          <div class="twoCol">
            <div>
              <label>Data de quitação (dd/mm/aaaa)</label>
              <input id="dataQuitacao" value="03/02/2026" inputmode="numeric" maxlength="10" />
            </div>
            <div>
              <label>Após qual parcela paga?</label>
              <select id="aposParcela"></select>
            </div>
          </div>

          <div class="kpi" id="kpiBox" style="margin-top:12px; display:none;">
            <div>
              <div style="font-weight:900;color:#5c0b17;letter-spacing:.2px;">VALOR PARA QUITAÇÃO (VP DAS PARCELAS VINCENDAS)</div>
              <p class="big" id="kpiVP">R$ 0,00</p>
              <div class="sub" id="kpiMeta"></div>
            </div>
            <div class="miniCards">
              <div class="mini">
                <div class="t">PV financiado</div>
                <div class="v" id="miniPV">R$ 0,00</div>
              </div>
              <div class="mini">
                <div class="t">Prestação (Price)</div>
                <div class="v" id="miniPMT">R$ 0,00</div>
              </div>
              <div class="mini">
                <div class="t">Taxa efetiva (a.a.)</div>
                <div class="v" id="miniTaxa">0,000000%</div>
              </div>
            </div>
            <div class="note" id="kpiNote"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Results (minimal) -->
    <div class="card" style="margin-top:16px; display:none;" id="cardMemoria">
      <div class="hd">
        <div>Memória de cálculo</div>
        <div class="badge" style="display:block;background:#fff;color:#183549;border-color:rgba(31,125,170,.25)">auditável</div>
      </div>
      <div class="content">
        <div class="twoCol">
          <div class="mini">
            <div class="t">Identificação</div>
            <div class="v" id="identTxt" style="font-weight:800"></div>
            <div class="mutedRow" id="identSub"></div>
          </div>
          <div class="mini" style="border-color: rgba(176,0,32,.25); background: var(--dangerSoft);">
            <div class="t" style="color:#7b2a36">Quitação (VP)</div>
            <div class="v" id="memVP" style="color:var(--danger);font-size:20px;">R$ 0,00</div>
            <div class="mutedRow" id="memVPSub" style="color:#7b2a36"></div>
          </div>
        </div>

        <div class="sectionTitle">Fluxo natural e decisão de antecipar</div>
        <div class="note" style="margin-top:-6px;">A linha “QUITAR” marca o evento de antecipação e mostra o valor presente (VP) a pagar.</div>
        <div style="overflow:auto;">
          <table id="tblPrice"></table>
        </div>

        <div class="sectionTitle">Diagrama do valor presente</div>
        <div class="diagramWrap">
          <p class="diagramTitle" id="diagTitle">Valor Presente para Quitação</p>
          <div id="svgHost"></div>
          <div class="diagramHint">As setas indicam as parcelas futuras. A linha vermelha tracejada representa o desconto para trazer os valores à data de quitação.</div>
        </div>

        <details class="collapse">
          <summary>Detalhes técnicos (auditoria)</summary>
          <div class="inner">
            <div id="techTxt"></div>
          </div>
        </details>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <script>
    // ---------- formatting ----------
    const BRL = new Intl.NumberFormat('pt-BR', {style:'currency', currency:'BRL'});
    function moneyToNumber(v){
      if(v==null) return 0;
      const s = String(v).trim().replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',', '.');
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }
    function toBRL(x){ return BRL.format(x || 0); }

    function pad2(n){ return String(n).padStart(2,'0'); }
    function dateToBR(d){ return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`; }
    function parseBRDate(s){
      const m = String(s||'').match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if(!m) return null;
      const dd = Number(m[1]), mm = Number(m[2]), yy = Number(m[3]);
      const d = new Date(yy, mm-1, dd);
      if(d.getFullYear()!==yy || d.getMonth()!==mm-1 || d.getDate()!==dd) return null;
      return d;
    }
    function maskDateInput(el){
      el.addEventListener('input', ()=>{
        let v = el.value.replace(/[^\d]/g,'');
        if(v.length>8) v=v.slice(0,8);
        if(v.length>=5) el.value = v.slice(0,2)+'/'+v.slice(2,4)+'/'+v.slice(4);
        else if(v.length>=3) el.value = v.slice(0,2)+'/'+v.slice(2);
        else el.value = v;
      });
      el.addEventListener('blur', ()=>{
        const d = parseBRDate(el.value);
        if(!d) return;
        el.value = dateToBR(d);
      });
    }

    // ---------- math ----------
    function pmt(PV, i, n){
      if(n<=0) return 0;
      if(Math.abs(i) < 1e-12) return PV/n;
      const pow = Math.pow(1+i, n);
      return PV*(i*pow)/(pow-1);
    }
    function addMonths(dt, m){
      const d = new Date(dt.getTime());
      const y = d.getFullYear();
      const mo = d.getMonth();
      const day = d.getDate();
      const target = new Date(y, mo+m, 1);
      const maxDay = new Date(target.getFullYear(), target.getMonth()+1, 0).getDate();
      target.setDate(Math.min(day, maxDay));
      return target;
    }
    function addYears(dt, y){
      const d = new Date(dt.getTime());
      const target = new Date(d.getFullYear()+y, d.getMonth(), d.getDate());
      // handle Feb 29
      if(target.getMonth()!==d.getMonth()) return new Date(d.getFullYear()+y, d.getMonth(), 28);
      return target;
    }
    function discountFactor(taxaAA, dias, base=365){
      return 1 / Math.pow(1+taxaAA, dias/base);
    }

    // ---------- UI helpers ----------
    const toast = (msg)=>{
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(()=>el.classList.remove('show'), 1800);
    }
    const setBusy = (busy)=>{
      const btn = document.getElementById('btnCalc');
      const icon = document.getElementById('btnCalcIcon');
      btn.disabled = !!busy;
      icon.innerHTML = busy ? '<span class="spinner"></span>' : '';
    }

    // ---------- state ----------
    let STATE = { rows:[], details:[], vp:0, PV:0, PMT:0, i:0 };

    function syncAposParcelaOptions(n){
      const sel = document.getElementById('aposParcela');
      const current = Number(sel.value || 1);
      sel.innerHTML = '';
      for(let k=0;k<=n;k++){
        const opt = document.createElement('option');
        opt.value = String(k);
        opt.textContent = (k===0) ? 'Nenhuma parcela paga (após 0)' : `Após pagar a parcela ${k}`;
        sel.appendChild(opt);
      }
      sel.value = String(Math.min(Math.max(current,0), n));
    }

    function readInputs(){
      const contratos = document.getElementById('contratos').value.trim();
      const colaborador = document.getElementById('colaborador').value.trim();
      const solicitante = document.getElementById('solicitante').value.trim();
      const email = document.getElementById('email').value.trim();
      const negociado = moneyToNumber(document.getElementById('negociado').value);
      const sinal = moneyToNumber(document.getElementById('sinal').value);
      const jurosAA = Number(String(document.getElementById('jurosAA').value).replace(',','.'))/100;
      const periodicidade = document.getElementById('periodicidade').value;
      const n = Number(document.getElementById('n').value);
      const primeiroVenc = parseBRDate(document.getElementById('primeiroVenc').value);
      const dataBase = parseBRDate(document.getElementById('dataBase').value);
      const dataQuitacao = parseBRDate(document.getElementById('dataQuitacao').value);
      const aposParcela = Number(document.getElementById('aposParcela').value);

      if(!primeiroVenc || !dataQuitacao || !dataBase || !Number.isFinite(jurosAA) || !Number.isFinite(n) || n<=0){
        return { ok:false };
      }

      const PV = Math.max(0, negociado - sinal);
      const i = (periodicidade==='MENSAL') ? Math.pow(1+jurosAA, 1/12)-1 : jurosAA;
      return { ok:true, contratos, colaborador, solicitante, email, negociado, sinal, jurosAA, periodicidade, n, primeiroVenc, dataBase, dataQuitacao, aposParcela, PV, i };
    }

    function buildSchedule(PV, i, n, primeiroVenc, periodicidade){
      const PMT = pmt(PV, i, n);
      let saldo = PV;
      const rows = [];
      for(let k=1;k<=n;k++){
        const venc = (periodicidade==='MENSAL') ? addMonths(primeiroVenc, k-1) : addYears(primeiroVenc, k-1);
        const juros = saldo*i;
        const amort = PMT - juros;
        const saldoFim = saldo - amort;
        rows.push({k, venc, saldoIni:saldo, juros, PMT, amort, saldoFim});
        saldo = saldoFim;
      }
      // ajuste final para saldo=0
      const last = rows[rows.length-1];
      const ajuste = last.saldoFim;
      last.amort += ajuste;
      last.saldoFim = 0;
      return { rows, PMT };
    }

    function calcQuitacao(rows, kPago, dataQuitacao, taxaAA){
      const base = 365;
      const remaining = rows.filter(r => r.k > kPago);
      let vp = 0;
      const details = remaining.map(r => {
        const dias = Math.round((r.venc - dataQuitacao) / (1000*60*60*24));
        const df = discountFactor(taxaAA, dias, base);
        const vpParc = r.PMT * df;
        vp += vpParc;
        return {k:r.k, venc:r.venc, dias, df, PMT:r.PMT, vpParc};
      });
      return { vp, details, vincendas: remaining.length };
    }

    function renderTable(rows, kPago, dataQuitacao, vp){
      const tbl = document.getElementById('tblPrice');
      const head = `
        <thead>
          <tr>
            <th>#</th><th>Vencimento</th>
            <th>Saldo inicial</th><th>Juros</th><th>Prestação</th><th>Amortização</th><th>Saldo final</th>
          </tr>
        </thead>`;
      let body = '<tbody>';

      rows.forEach(r=>{
        if(r.k === kPago+1){
          body += `
            <tr class="eventRow">
              <td colspan="7">
                QUITAR em <b>${dateToBR(dataQuitacao)}</b> &nbsp;•&nbsp; <span class="small">VP das vincendas</span> <b>${toBRL(vp)}</b>
              </td>
            </tr>`;
        }
        body += `
          <tr>
            <td>${r.k}</td>
            <td>${dateToBR(r.venc)}</td>
            <td>${toBRL(r.saldoIni)}</td>
            <td>${toBRL(r.juros)}</td>
            <td>${toBRL(r.PMT)}</td>
            <td>${toBRL(r.amort)}</td>
            <td>${toBRL(r.saldoFim)}</td>
          </tr>`;
      });
      body += '</tbody>';
      tbl.innerHTML = head + body;
    }

    function renderDiagram(details, dataQuitacao, vp){
      // Minimal SVG similar to user's reference: baseline, arrows at parcel indices, dashed red bracket from 1..m
      const host = document.getElementById('svgHost');
      const n = details.length;
      const W = 920, H = 220, padL=60, padR=30, yBase=140;
      const x0 = padL, x1 = W-padR;
      const step = (x1-x0)/Math.max(1, n);
      const vpTxt = toBRL(vp);

      // markers at 1..n, arrows down
      let ticks = '';
      for(let i=1;i<=n;i++){
        const x = x0 + step*i;
        ticks += `
          <line x1="${x}" y1="${yBase-6}" x2="${x}" y2="${yBase+55}" stroke="#0f2233" stroke-width="2"/>
          <polygon points="${x-6},${yBase+55} ${x+6},${yBase+55} ${x},${yBase+68}" fill="#0f2233" />
          <text x="${x}" y="${yBase+88}" font-size="14" font-weight="800" fill="#0f2233" text-anchor="middle">${i}</text>
        `;
      }

      // red dashed top bracket
      const xStart = x0 + step*1;
      const xEnd = x0 + step*n;
      let redDrops = '';
      for(let i=1;i<=n;i++){
        const x = x0 + step*i;
        redDrops += `<line x1="${x}" y1="${yBase-55}" x2="${x}" y2="${yBase-30}" stroke="#b00020" stroke-width="3" stroke-dasharray="8 6" />`;
      }

      const svg = `
      <svg viewBox="0 0 ${W} ${H}" width="100%" height="220" role="img" aria-label="Diagrama de valor presente">
        <!-- axes -->
        <line x1="${x0}" y1="${yBase}" x2="${x1}" y2="${yBase}" stroke="#0f2233" stroke-width="3"/>
        <polygon points="${x1},${yBase} ${x1-12},${yBase-6} ${x1-12},${yBase+6}" fill="#0f2233"/>

        <line x1="${x0}" y1="${yBase}" x2="${x0}" y2="${yBase-95}" stroke="#1f7daa" stroke-width="4"/>
        <polygon points="${x0},${yBase-95} ${x0-6},${yBase-83} ${x0+6},${yBase-83}" fill="#1f7daa"/>

        <!-- title -->
        <text x="${x0+10}" y="40" font-size="22" font-weight="900" fill="#0f2233">Valor Presente para Quitação:</text>
        <text x="${x0+10}" y="72" font-size="28" font-weight="900" fill="#0f2233">${vpTxt}</text>

        <!-- quit date -->
        <text x="${x0+5}" y="${yBase+38}" font-size="14" font-weight="800" fill="#0f2233">Data de quitação:</text>
        <text x="${x0+5}" y="${yBase+60}" font-size="16" font-weight="900" fill="#0f2233">${dateToBR(dataQuitacao)}</text>

        <!-- red dashed bracket -->
        <line x1="${xStart}" y1="${yBase-55}" x2="${xEnd}" y2="${yBase-55}" stroke="#b00020" stroke-width="4" stroke-dasharray="10 8"/>
        <polygon points="${xStart},${yBase-55} ${xStart+14},${yBase-61} ${xStart+14},${yBase-49}" fill="#b00020"/>
        ${redDrops}

        <!-- ticks/arrows -->
        ${ticks}
      </svg>`;
      host.innerHTML = svg;
    }

    function sha256Hex(str){
      // browser-native crypto
      const enc = new TextEncoder().encode(str);
      return crypto.subtle.digest('SHA-256', enc).then(buf=>{
        const bytes = Array.from(new Uint8Array(buf));
        return bytes.map(b=>b.toString(16).padStart(2,'0')).join('');
      });
    }

    async function runSimulation(){
      setBusy(true);
      document.getElementById('badgeOk').style.display = 'none';

      // small delay to make feedback visible in fast machines
      await new Promise(r=>setTimeout(r, 120));

      const inp = readInputs();
      if(!inp.ok){
        setBusy(false);
        toast('Preencha datas no padrão dd/mm/aaaa');
        return;
      }

      syncAposParcelaOptions(inp.n);

      const sch = buildSchedule(inp.PV, inp.i, inp.n, inp.primeiroVenc, inp.periodicidade);
      const q = calcQuitacao(sch.rows, inp.aposParcela, inp.dataQuitacao, inp.jurosAA);

      STATE = { rows: sch.rows, PMT: sch.PMT, PV: inp.PV, i: inp.i, vp: q.vp, details: q.details, vincendas: q.vincendas, inp };

      // KPIs
      document.getElementById('kpiBox').style.display = 'grid';
      document.getElementById('kpiVP').textContent = toBRL(q.vp);
      document.getElementById('kpiMeta').textContent = `Data: ${dateToBR(inp.dataQuitacao)} | Após parcela: ${inp.aposParcela} | Vincendas: ${q.vincendas}`;
      document.getElementById('miniPV').textContent = toBRL(inp.PV);
      document.getElementById('miniPMT').textContent = toBRL(sch.PMT);
      document.getElementById('miniTaxa').textContent = (inp.jurosAA*100).toFixed(6) + '%';
      document.getElementById('kpiNote').textContent = 'Quitação = Σ (PMT × DF), com DF = 1/(1+r)^(dias/365).';

      // Memory (minimal)
      document.getElementById('cardMemoria').style.display = 'block';
      document.getElementById('identTxt').textContent = `Contrato(s): ${inp.contratos}`;
      document.getElementById('identSub').textContent = `Solicitante: ${inp.solicitante} | Contato: ${inp.email} | Colaborador: ${inp.colaborador} | Data-base: ${dateToBR(inp.dataBase)}`;
      document.getElementById('memVP').textContent = toBRL(q.vp);
      document.getElementById('memVPSub').textContent = `Quitação em ${dateToBR(inp.dataQuitacao)} | Após parcela ${inp.aposParcela} | Vincendas ${q.vincendas}`;

      renderTable(sch.rows, inp.aposParcela, inp.dataQuitacao, q.vp);
      renderDiagram(q.details, inp.dataQuitacao, q.vp);

      // tech hash
      const payload = {
        contratos: inp.contratos, colaborador: inp.colaborador, solicitante: inp.solicitante, email: inp.email,
        negociado: document.getElementById('negociado').value, sinal: document.getElementById('sinal').value,
        jurosAA: document.getElementById('jurosAA').value, periodicidade: inp.periodicidade, n: inp.n,
        primeiroVenc: document.getElementById('primeiroVenc').value, dataBase: document.getElementById('dataBase').value,
        dayCount: 'ACT/365', dataQuitacao: document.getElementById('dataQuitacao').value, aposParcela: inp.aposParcela
      };
      const h = await sha256Hex(JSON.stringify(payload));
      document.getElementById('techTxt').innerHTML =
        `<b>Premissas:</b> Price; desconto composto com expoente fracionário; base ACT/365.<br/>` +
        `<b>Hash (SHA-256) dos inputs:</b> <span style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;">${h}</span>`;

      document.getElementById('badgeOk').style.display = 'block';
      document.getElementById('badgeVP').style.display = 'block';
      toast('Simulação processada');
      setBusy(false);
    }

    function ensureSimulated(){
      if(!STATE.rows || STATE.rows.length===0) return runSimulation();
      return Promise.resolve();
    }

    function pdfReport(){
      if(!STATE.rows || STATE.rows.length===0){ toast('Calcule a quitação antes de gerar PDF'); return; }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:'pt', format:'a4'});
      const margin = 48;

      const inp = STATE.inp;
      const title = 'Renegociação | Relatório de Quitação Antecipada';
      doc.setFont('helvetica','bold'); doc.setFontSize(16);
      doc.text(title, margin, 52);

      doc.setFont('helvetica','normal'); doc.setFontSize(10);
      doc.setTextColor(90,114,134);
      doc.text('Resumo do fluxo natural (Tabela Price) e decisão de antecipar via Valor Presente (VP).', margin, 72);

      doc.setTextColor(15,34,51);
      doc.setFontSize(10);
      doc.text(`Contrato(s): ${inp.contratos}   Solicitante: ${inp.solicitante}`, margin, 98);
      doc.text(`Contato: ${inp.email}   Colaborador: ${inp.colaborador}`, margin, 114);
      doc.text(`Data-base: ${dateToBR(inp.dataBase)}   1º vencimento: ${dateToBR(inp.primeiroVenc)}`, margin, 130);

      // KPI box
      doc.setDrawColor(215,230,242);
      doc.setFillColor(253,236,238);
      doc.roundedRect(margin, 148, 520, 64, 10, 10, 'FD');

      doc.setFont('helvetica','bold'); doc.setFontSize(10); doc.setTextColor(123,42,54);
      doc.text('VALOR PARA QUITAÇÃO (VP DAS PARCELAS VINCENDAS)', margin+14, 168);
      doc.setFontSize(18); doc.setTextColor(176,0,32);
      doc.text(toBRL(STATE.vp), margin+14, 192);

      doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(123,42,54);
      doc.text(`Quitação em ${dateToBR(inp.dataQuitacao)} | Após parcela ${inp.aposParcela} | Vincendas ${STATE.vincendas}`, margin+14, 208);

      // Table: natural flow + decision row
      const head = [['#','Vencimento','Saldo ini.','Juros','Prestação','Amort.','Saldo fim.']];
      const body = [];
      STATE.rows.forEach(r=>{
        if(r.k === inp.aposParcela+1){
          body.push([{content:`QUITAR em ${dateToBR(inp.dataQuitacao)} | VP: ${toBRL(STATE.vp)}`, colSpan:7, styles:{fillColor:[253,236,238], textColor:[176,0,32], fontStyle:'bold', halign:'left'}}]);
        }
        body.push([
          String(r.k),
          dateToBR(r.venc),
          toBRL(r.saldoIni),
          toBRL(r.juros),
          toBRL(r.PMT),
          toBRL(r.amort),
          toBRL(r.saldoFim)
        ]);
      });

      doc.setFont('helvetica','bold'); doc.setFontSize(11); doc.setTextColor(24,53,73);
      doc.text('Fluxo natural de pagamento e decisão de antecipar', margin, 244);

      doc.autoTable({
        startY: 258,
        head, body,
        styles: { font:'helvetica', fontSize:8, cellPadding:4, lineColor:[237,244,251], lineWidth:0.5 },
        headStyles: { fillColor:[247,251,255], textColor:[24,53,73] },
        columnStyles: { 0:{halign:'center'}, 1:{halign:'left'} },
        tableLineColor:[215,230,242], tableLineWidth:0.8,
        margin: {left: margin, right: margin}
      });

      // technical footer
      const endY = doc.lastAutoTable.finalY + 18;
      doc.setFont('helvetica','bold'); doc.setFontSize(10); doc.setTextColor(24,53,73);
      doc.text('Detalhes técnicos (auditoria)', margin, endY);
      doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.setTextColor(90,114,134);
      doc.text('Premissas: Price; desconto composto com expoente fracionário; base ACT/365.', margin, endY+14);

      // hash
      const tech = document.getElementById('techTxt').innerText.replace(/\s+/g,' ').trim();
      doc.text(tech.slice(0, 110), margin, endY+28);
      if(tech.length>110) doc.text(tech.slice(110, 220), margin, endY+40);

      doc.save(`Relatorio_Quitacao_${inp.contratos || 'contrato'}.pdf`);
      toast('PDF gerado');
    }

    // ---------- events ----------
    document.getElementById('btnCalc').addEventListener('click', runSimulation);
    document.getElementById('btnTabela').addEventListener('click', async ()=>{
      await ensureSimulated();
      document.getElementById('cardMemoria').scrollIntoView({behavior:'smooth', block:'start'});
      toast('Tabela exibida');
    });
    document.getElementById('btnPDF').addEventListener('click', async ()=>{
      await ensureSimulated();
      pdfReport();
    });

    // re-sync options when n changes
    document.getElementById('n').addEventListener('input', ()=>{
      const n = Math.max(1, Number(document.getElementById('n').value||1));
      syncAposParcelaOptions(n);
    });

    // apply masks
    ['primeiroVenc','dataQuitacao','dataBase'].forEach(id=>maskDateInput(document.getElementById(id)));

    // init
    syncAposParcelaOptions(Number(document.getElementById('n').value||5));
  </script>
</body>
</html>
